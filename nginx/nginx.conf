server {
  listen 8080;

  server_name siacdn.com www.siacdn.com new.siacdn.com;

  if ($http_x_forwarded_proto = "http") {
    return 301 https://$server_name$request_uri;
  }

  rewrite ^/skynet/skyfile/?$ /skynet/skyfile/$request_id$1$is_args$args;

  location /.well-known/skynet-portals.json {
    alias /etc/skynet/portals.json;
  
    add_header Cache-Control public;
    expires 1h;
    etag on;
  }

  location / {
    client_max_body_size 1000M;
    proxy_read_timeout 600;

    add_header Cache-Control public;
    expires 1h;
    etag on;

    proxy_pass http://127.0.0.1:3000;
    #gzip_proxied any;
    #gzip_vary on;
    proxy_http_version 1.1;
    proxy_set_header Access-Control-Allow-Origin: *;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
  }

  location /stats {
    proxy_set_header Access-Control-Allow-Origin: *;
    proxy_set_header User-Agent: Sia-Agent;
    proxy_set_header Authorization "Basic WRITE_BASE64_AUTHENTICATION";
    proxy_pass http://127.0.0.1:9970/skynet/stats;
  }

  location /statsdown {
    proxy_set_header Access-Control-Allow-Origin: *;
    proxy_set_header User-Agent: Sia-Agent;
    proxy_set_header Authorization "Basic READ_BASE64_AUTHENTICATION";
    proxy_pass http://127.0.0.1:9980/skynet/stats;
  }

  location /skynet/skyfile/ {
    client_max_body_size 1000M;
    proxy_read_timeout 600;

    add_header Cache-Control public;
    expires max;
    etag on;

    # proxy this call to siad endpoint
    set $authHeader "";
    if ($request_method = GET) {
      proxy_pass http://127.0.0.1:9980;
      set $authHeader "Basic READ_BASE64_AUTHENTICATION";
    }
    if ($request_method != GET) {
      proxy_pass http://127.0.0.1:9970;
      set $authHeader "Basic WRITE_BASE64_AUTHENTICATION";
    }
    proxy_set_header Authorization $authHeader;
    #gzip_proxied any;
    #gzip_vary on;

    proxy_http_version 1.1;
    proxy_set_header Expect $http_expect;
    add_header Access-Control-Allow-Origin *;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;

    proxy_set_header User-Agent: Sia-Agent;
    proxy_pass_header Authorization;
  }

  location ~ "^/([a-zA-Z0-9-_]{46}(/.*)?)$" {
    proxy_read_timeout 600;

    add_header Cache-Control public;
    expires max;
    etag on;

    # proxy this call to siad /skynet/skylink/ endpoint (make sure the ip is correct)
    set $authHeader "";
    if ($request_method = GET) {
      proxy_pass http://127.0.0.1:9980/skynet/skylink/$1$is_args$args;
      set $authHeader "Basic READ_BASE64_AUTHENTICATION";
    }
    if ($request_method != GET) {
      proxy_pass http://127.0.0.1:9970/skynet/skylink/$1$is_args$args;
      set $authHeader "Basic WRITE_BASE64_AUTHENTICATION";
    }
    proxy_set_header Authorization $authHeader;
    #gzip_proxied any;
    #gzip_vary on;

    proxy_http_version 1.1;
    add_header Access-Control-Allow-Origin *;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;

    add_header Access-Control-Expose-Headers skynet-file-metadata;

    proxy_set_header User-Agent: Sia-Agent;
    proxy_pass_header Authorization;
  }

  location ~ "^/file/([a-zA-Z0-9-_]{46}(/.*)?)$" {
    proxy_read_timeout 600;

    add_header Cache-Control public;
    expires max;
    etag on;

    # proxy this call to siad /skunet/skylink/ endpoint (make sure the ip is correct)
    # this alias also adds attachment=true url param to force download the file
    set $authHeader "";
    if ($request_method = GET) {
      proxy_pass http://127.0.0.1:9980/skynet/skylink/$1?attachment=true&$args;
      set $authHeader "Basic READ_BASE64_AUTHENTICATION";
    }
    if ($request_method != GET) {
      proxy_pass http://127.0.0.1:9970/skynet/skylink/$1?attachment=true&$args;
      set $authHeader "Basic WRITE_BASE64_AUTHENTICATION";
    }
    proxy_set_header Authorization $authHeader;
    #gzip_proxied any;
    #gzip_vary on;

    proxy_http_version 1.1;
    proxy_set_header Access-Control-Allow-Origin: *;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;

    add_header Access-Control-Expose-Headers skynet-file-metadata;

    proxy_set_header User-Agent: Sia-Agent;
    proxy_pass_header Authorization;
  }
}